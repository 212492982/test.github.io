# 存储引擎

## InnoDB

  是MySQL5.6中的默认引擎，支持ACID及MVCC，是目前使用较为广泛的存储引擎。
  - B+树，每个节点一个page，page大小为16k，非子节点只存索引键值，叶子节点存完整数据
  - 非主键索引的叶子节点存的是主键，索引成功后走主键索引

## MyISAM

  MySQL5.5及以前版本默认的虽然有其独有特性，但是不支持事务、不支持行级锁，不适用于OLTP系统

  - 联机事务处理OLTP（on-line transaction processing）
  - 联机分析处理OLAP（On-Line Analytical Processing）

# 缓存

一般不用，缺陷大于有点，通常使用第三方缓存

```sql
SHOW VARIABLES LIKE '%query_cache%';
```

# 执行计划

## 语句

```sql
  explain select * from user where name="timmy";
```

## 计划表字段解释

- select_type
  - SIMPLE 简单 无union和子查询
  - PRIMARY 最外层 通常与其他查询方式组合
  - SUBQUERY 子查询
- type 扫描类型 下面由慢到快
  - ALL 全表扫描
  - index 索引扫描
  - range 范围扫描 like 'xx%' age>16 and age<18
  - index_subquery
  - unique_subquery
  - index_merge
  - ref_or_null 索引的基础上增加or age is null
  - fulltext
  - ref 非唯一索引扫描
  - eq_ref 唯一索引扫描
  - const 常数引用 主键或唯一索引的查询
  - system 没试出来
  - null 不访问任何表 explain select now();
- table 输出行数据所在表
- partitions
- possible_keys 该查询可以使用的索引
- key 该查询实际使用的索引
- key_len 索引使用的字节数
- ref 连接匹配条件
  - 主键索引 const
  - 全表扫描 null
- rows 扫描行数 关联查询会比实际返回的数量大
- filtered 
- Extra 执行时真实情况信息
  - using where 使用where筛选得到的值
  - using temporary 使用临时表
  - using filesort 使用文件排序
  - Using index，使用到索引
  - Using index conditio，使用到索引过滤
  - Using MRR，使用到索引内部排序

# 分库分表分区分片

## 分库

  - 垂直分库 按照业务模块拆分，尤其高并发服务需要单独库以免跑死其他服务
  - 水平分库 单表太大，分散到多个库中的相同表，分散节点资源

## 分表

  - 垂直分表
    - 将主键与频繁使用的字段（比如状态）放在主表中
    - 内容较大或不需频繁访问可以需要时再查询的字段放入信息表中
  - 水平分表
    - 为了解决单表数量过大的问题
    - 单库分表可以是多张表也可以是分区提升有限，不能解决IO和网络瓶颈

## 分库分表的问题

  - 分布式事务需要解决
  - 跨节点关联查询
  - 跨节点分页、排序
  - 主键避重和唯一索引问题
  - 公共表

## 分区

```sql
PARTITION BY LIST COLUMNS(file_mark)
(
  PARTITION p_1101 VALUES IN ('1101') ENGINE=innoDB,
  PARTITION p_2101 VALUES IN ('2101') ENGINE=innoDB,
  PARTITION p_2102 VALUES IN ('2102') ENGINE=innoDB
)
```

## 分片

  - 根据表中指定字段分片（比如工单来源），每一片会存储于mysql集群中不同的节点，分散IO和网络
  - 消费者以独占锁机制获取消费其中某一个分片的许可

## Sharding-JDBC

### 原理

  - 解析
    - 词法分析 tokens
    - 语法分析 语法树
  - 路由
    - 分片键符号不同
      - 单片路由 等号 确定一个节点
      - 多片路由 in
      - 范围路由 between
    - 不带分片键
      - 广播路由，全库表路由
    - 根据分片键进行路由
      - 标准路由 不包括关联查询或仅限绑定表关联查询（实际对逻辑表来说不是关联）
      - 直接路由？
      - 笛卡尔积路由 主表与子表不知道怎么组合，所以都组合一遍
  - 改写
    - 改表名 逻辑表改为真实表
    - 补充列 为归并准备 group by order by
  - 执行
    - 内存限制模式 多线程，可并行 适合OLAP
    - 连接限制模式 可单连接串行控制事务 适合OLTP
  - 归并
    - 场景
      - 遍历 select
      - 排序
      - 分组
      - 分页
      - 聚合
    - 种类
      - 内存归并 消耗内存
      - 流式归并 比如排序，每次比较所有队列首，处理最大的并修改下表，再重复执行
      - 装饰者归并 比如聚合函数sum 在之前和的基础上再求和

# 读写分离、主从复制

# 碎片整理

# 备份
